name: Dependency Graph Auto-Submission

# This workflow validates Python dependencies and ensures compatibility
# Triggered on push to main branch and pull requests
'on':
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # Allow manual workflow dispatch for testing
  workflow_dispatch:

jobs:
  dependency-validation:
    # Use the latest Ubuntu runner for consistency
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      # Uses actions/checkout@v4 for secure and up-to-date repository access
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate dependency analysis
          fetch-depth: 0
      
      # Step 2: Set up Python 3.10
      # Uses actions/setup-python@v5 for Python environment configuration
      # Python 3.10 is the standardized version for this project
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # Enable caching for faster subsequent runs
          cache: 'pip'
      
      # Step 3: Validate Python project structure
      # Check for required dependency files at repository root
      - name: Validate Python project structure
        id: validate-structure
        run: |
          echo "üîç Checking for Python dependency files..."
          
          # Initialize found files counter
          found_files=0
          
          # Check for requirements.txt
          if [ -f "requirements.txt" ]; then
            echo "‚úÖ Found requirements.txt"
            found_files=$((found_files + 1))
          fi
          
          # Check for pyproject.toml
          if [ -f "pyproject.toml" ]; then
            echo "‚úÖ Found pyproject.toml"
            found_files=$((found_files + 1))
          fi
          
          # Check for setup.py
          if [ -f "setup.py" ]; then
            echo "‚úÖ Found setup.py"
            found_files=$((found_files + 1))
          fi
          
          # Validate that at least one dependency file exists
          if [ $found_files -eq 0 ]; then
            echo "‚ùå ERROR: No Python dependency files found!"
            echo "‚ö†Ô∏è  Expected at least one of: requirements.txt, pyproject.toml, or setup.py"
            echo "::error::Python dependency files are missing from repository root"
            exit 1
          fi
          
          echo "‚úÖ Found $found_files dependency file(s) - validation passed"
          echo "dependency-files-found=$found_files" >> $GITHUB_OUTPUT
      
      # Step 4: Upgrade pip and install pip-tools
      # Ensures we have the latest secure versions
      - name: Install pip and pip-tools
        run: |
          echo "üì¶ Upgrading pip..."
          python -m pip install --upgrade pip
          
          echo "üì¶ Installing pip-tools for dependency compilation..."
          pip install --upgrade "pip-tools>=7.0.0"
          
          echo "‚úÖ Package installation complete"
          
          # Display versions for debugging
          echo "üìã Installed versions:"
          pip --version
          pip-compile --version
      
      # Step 5: Validate dependencies with pip-compile
      # Checks for conflicts and compatibility issues
      - name: Validate dependencies with pip-compile
        id: validate-dependencies
        continue-on-error: true
        run: |
          echo "üîç Starting dependency validation..."
          
          # Track validation status
          validation_failed=0
          validation_warnings=0
          
          # Validate requirements.txt if it exists
          if [ -f "requirements.txt" ]; then
            echo "üìù Validating requirements.txt..."
            
            # Create a temporary requirements.in for validation
            cp requirements.txt requirements.in.tmp
            
            # Try to compile dependencies to check for conflicts
            # Use a more lenient approach with continue-on-error
            if pip-compile --dry-run --resolver=backtracking requirements.in.tmp > /dev/null 2>&1; then
              echo "‚úÖ requirements.txt validation passed"
            else
              echo "‚ö†Ô∏è  requirements.txt validation found issues"
              echo "::warning::Dependency conflicts detected in requirements.txt - will attempt installation anyway"
              
              # Show detailed error output
              echo "üîç Detailed validation output:"
              pip-compile --dry-run --resolver=backtracking requirements.in.tmp 2>&1 || true
              
              validation_warnings=1
            fi
            
            # Clean up temporary file
            rm -f requirements.in.tmp
          fi
          
          # Validate pyproject.toml if it exists
          if [ -f "pyproject.toml" ]; then
            echo "üìù Validating pyproject.toml..."
            
            # Check if pyproject.toml has valid syntax using proper file handling
            if python -c "import sys; \
               try: import tomli; \
               except ImportError: import tomllib as tomli; \
               with open('pyproject.toml', 'rb') as f: tomli.load(f)" 2>/dev/null; then
              echo "‚úÖ pyproject.toml syntax validation passed"
            else
              echo "‚ö†Ô∏è  pyproject.toml syntax validation failed"
              echo "::warning::pyproject.toml syntax validation failed - continuing anyway"
              validation_warnings=1
            fi
          fi
          
          # Check for security vulnerabilities (optional but recommended)
          if [ -f "requirements.txt" ]; then
            echo "üîí Checking for known security vulnerabilities..."
            
            # Install safety for vulnerability scanning
            pip install safety 2>/dev/null || true
            
            # Run safety check (non-blocking)
            if command -v safety &> /dev/null; then
              safety check --file requirements.txt --output text || echo "‚ö†Ô∏è  Some vulnerabilities detected (non-blocking)"
            fi
          fi
          
          # Report status but don't fail the workflow on validation warnings
          if [ $validation_failed -ne 0 ]; then
            echo "::error::Critical dependency validation errors detected"
            exit 1
          elif [ $validation_warnings -ne 0 ]; then
            echo "::warning::Some dependency validation warnings detected - proceeding with installation"
          else
            echo "‚úÖ All dependency validations passed successfully"
          fi
      
      # Step 6: Install project dependencies
      # Verify that dependencies can be installed without conflicts
      - name: Install project dependencies
        continue-on-error: false
        run: |
          echo "üì¶ Installing project dependencies..."
          
          # Try to install from requirements.txt first
          if [ -f "requirements.txt" ]; then
            echo "Installing from requirements.txt..."
            
            # Show what will be installed
            echo "üîç Dry-run installation preview:"
            pip install -r requirements.txt --no-deps --dry-run 2>&1 | head -20 || true
            
            echo ""
            echo "üì¶ Starting actual installation..."
            
            # Attempt installation with retries
            max_retries=3
            retry_count=0
            install_success=false
            
            while [ $retry_count -lt $max_retries ] && [ "$install_success" = false ]; do
              if [ $retry_count -gt 0 ]; then
                echo "‚ö†Ô∏è  Installation attempt $((retry_count + 1)) of $max_retries..."
                sleep 5
              fi
              
              if pip install -r requirements.txt; then
                echo "‚úÖ Successfully installed dependencies from requirements.txt"
                install_success=true
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "‚ö†Ô∏è  Installation failed, retrying..."
                fi
              fi
            done
            
            if [ "$install_success" = false ]; then
              echo "‚ùå Failed to install dependencies after $max_retries attempts"
              echo "::error::Dependency installation failed - please check requirements.txt for invalid versions"
              exit 1
            fi
          # Fallback to pyproject.toml if requirements.txt doesn't exist
          elif [ -f "pyproject.toml" ]; then
            echo "Installing from pyproject.toml..."
            
            if pip install -e .; then
              echo "‚úÖ Successfully installed dependencies from pyproject.toml"
            else
              echo "‚ùå Failed to install dependencies from pyproject.toml"
              echo "::error::Dependency installation failed"
              exit 1
            fi
          fi
          
          echo "‚úÖ Dependency installation complete"
      
      # Step 7: Generate dependency report
      # Provides summary of installed packages for audit trail
      - name: Generate dependency report
        if: success() || failure()
        run: |
          echo "üìä Generating dependency report..."
          
          # List all installed packages with versions
          echo "=== Installed Packages ==="
          pip list --format=freeze
          
          # Show dependency tree if available
          pip install pipdeptree 2>/dev/null || true
          if command -v pipdeptree &> /dev/null; then
            echo ""
            echo "=== Dependency Tree ==="
            pipdeptree --warn silence || true
          fi
          
          echo "‚úÖ Dependency report generated"
      
      # Step 8: Summary report
      # Provides clear outcome of the workflow
      - name: Workflow summary
        if: always()
        run: |
          echo "üìã Workflow Summary"
          echo "==================="
          echo "Runner: ubuntu-latest"
          echo "Python Version: 3.10"
          echo "Dependency Files Found: ${{ steps.validate-structure.outputs.dependency-files-found }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ All checks passed successfully"
          else
            echo "‚ùå Some checks failed - please review the logs above"
          fi
