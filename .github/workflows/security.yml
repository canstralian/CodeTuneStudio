name: Security Pipeline

on: [push, pull_request]

permissions:
  contents: read

jobs:
  secrets:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Check out code with full history
        uses: actions/checkout@6b42224f41ee5dfe5395e27c8b2746f1f9955030  # v4.2.2
        with:
          fetch-depth: 0

      - name: Run TruffleHog secret scanner
        uses: trufflesecurity/trufflehog@ecb05f407947857f313624ee2f13b0ab9519c271
        with:
          extra_args: --only-verified

  dependencies:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@6b42224f41ee5dfe5395e27c8b2746f1f9955030  # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: "3.11"

      - name: Run pip-audit
        uses: pypa/gh-action-pip-audit@3152ba5c5483e87342795b7d5d35b472fc5becfd
        with:
          inputs: requirements.txt

  sbom:
    name: SBOM Generation
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@6b42224f41ee5dfe5395e27c8b2746f1f9955030  # v4.2.2

      - name: Generate SBOM
        uses: anchore/sbom-action@ad568ce3311e234f70bfb2e9f0a98d0139e685ad
        with:
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        with:
          name: sbom
          path: sbom.cyclonedx.json
          retention-days: 90
