name: Enhanced CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Stage 1: Environment Validation
  validate-environment:
    name: Validate Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Validate Python version
        run: |
          python --version
          echo "Python version validated"

      - name: Check required files
        run: |
          for file in pyproject.toml requirements.txt README.md; do
            if [ ! -f "$file" ]; then
              echo "Error: $file not found"
              exit 1
            fi
          done
          echo "✓ All required files present"

      - name: Validate pyproject.toml
        run: |
          python -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb'))" 2>/dev/null || \
          python -c "import tomli; tomli.load(open('pyproject.toml', 'rb'))" || \
          python -c "import toml; toml.load('pyproject.toml')"
          echo "✓ pyproject.toml is valid"

  # Stage 2: Linting
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: validate-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black ruff

      - name: Run Flake8 (critical errors)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
            --exclude=venv,migrations,build,dist,*.egg-info

      - name: Run Flake8 (all errors)
        run: |
          flake8 . --count --max-complexity=10 --max-line-length=88 \
            --statistics --exclude=venv,migrations,build,dist,*.egg-info
        continue-on-error: true

      - name: Check code formatting with Black
        run: |
          black --check --line-length=88 --diff .
        continue-on-error: true

      - name: Run Ruff
        run: |
          ruff check .
        continue-on-error: true

  # Stage 3: Testing
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short --maxfail=3
        continue-on-error: false

      - name: Generate coverage report
        if: matrix.python-version == '3.10'
        run: |
          pytest tests/ --cov=. --cov-report=xml --cov-report=term
        continue-on-error: true

  # Stage 4: Build & Package
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Build distribution
        run: |
          python -m build
          echo "✓ Distribution built successfully"

      - name: Check distribution
        run: |
          pip install twine
          twine check dist/*
          echo "✓ Distribution validated"

      - name: List build artifacts
        run: |
          ls -lh dist/
          echo "Build artifacts:"
          for file in dist/*; do
            echo "  - $(basename $file)"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-distributions-${{ github.sha }}
          path: dist/
          retention-days: 7

  # Stage 5: Test Installation
  test-install:
    name: Test Package Installation
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-distributions-${{ github.sha }}
          path: dist/

      - name: Install package from wheel
        run: |
          pip install dist/*.whl
          echo "✓ Package installed from wheel"

      - name: Verify CLI is available
        run: |
          which codetune-studio || echo "CLI not in PATH"
          codetune-studio --version
          echo "✓ CLI command verified"

      - name: Verify package imports
        run: |
          python -c "from codetunestudio import __version__; print(f'Version: {__version__}')"
          echo "✓ Package imports verified"

  # Stage 6: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Run Safety check
        run: |
          pip install -r requirements.txt
          safety check --json || true
        continue-on-error: true

      - name: Run Bandit security scan
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -ll
        continue-on-error: true

  # Final Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-environment, lint, test, build, test-install, security-scan]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stage Results" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Environment Validation: ${{ needs.validate-environment.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Testing: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build & Package: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Installation Test: ${{ needs.test-install.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
