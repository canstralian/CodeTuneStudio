name: PR Checklist Status

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

# Ensure only one run per PR at a time; cancel older runs on the same branch
concurrency:
  group: pr-check-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------
  # Black Format Check (Non-blocking)
  # -----------------------------------------
  black-format:
    name: Black Format Check
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Cache pip packages to speed up subsequent runs
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-black-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-black-

      # Install Black
      - name: Install Black
        run: |
          python -m pip install --upgrade pip
          pip install black==25.11.0

      # Check formatting using Black (non-blocking)
      - name: Run Black (format check)
        id: black-check
        continue-on-error: true
        run: |
          black --check --diff .

      # Log Black results
      - name: Log Black results
        if: always()
        run: |
          if [ "${{ steps.black-check.outcome }}" == "failure" ]; then
            echo "::notice title=Black Formatting::Code formatting issues detected. Run 'black .' locally or use pre-commit hooks to fix."
            echo "## ⚠️ Black Formatting Issues Detected" >> "$GITHUB_STEP_SUMMARY"
            echo "Some files need reformatting. Please run:" >> "$GITHUB_STEP_SUMMARY"
            echo '```bash' >> "$GITHUB_STEP_SUMMARY"
            echo 'black .' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "Or install pre-commit hooks to automate this:" >> "$GITHUB_STEP_SUMMARY"
            echo '```bash' >> "$GITHUB_STEP_SUMMARY"
            echo 'pip install pre-commit' >> "$GITHUB_STEP_SUMMARY"
            echo 'pre-commit install' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::notice title=Black Formatting::All files are properly formatted"
            echo "## ✅ Black Formatting Check Passed" >> "$GITHUB_STEP_SUMMARY"
          fi

  # -----------------------------------------
  # Ruff Lint Check (Non-blocking)
  # -----------------------------------------
  ruff-lint:
    name: Ruff Lint Check
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Cache pip packages to speed up subsequent runs
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ruff-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-ruff-

      # Install Ruff
      - name: Install Ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.14.6

      # Lint code using Ruff (non-blocking)
      - name: Run Ruff (lint check)
        id: ruff-check
        continue-on-error: true
        run: |
          # Ignore long-line rule (handled by Black)
          # Exit non-zero if fixes would be applied
          ruff check . --ignore E501 --exit-non-zero-on-fix

      # Log Ruff results
      - name: Log Ruff results
        if: always()
        run: |
          if [ "${{ steps.ruff-check.outcome }}" == "failure" ]; then
            echo "::notice title=Ruff Linting::Code linting issues detected. Run 'ruff check . --fix' locally or use pre-commit hooks to fix."
            echo "## ⚠️ Ruff Linting Issues Detected" >> "$GITHUB_STEP_SUMMARY"
            echo "Some linting issues were found. Please run:" >> "$GITHUB_STEP_SUMMARY"
            echo '```bash' >> "$GITHUB_STEP_SUMMARY"
            echo 'ruff check . --fix' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "Or install pre-commit hooks to automate this:" >> "$GITHUB_STEP_SUMMARY"
            echo '```bash' >> "$GITHUB_STEP_SUMMARY"
            echo 'pip install pre-commit' >> "$GITHUB_STEP_SUMMARY"
            echo 'pre-commit install' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::notice title=Ruff Linting::No linting issues found"
            echo "## ✅ Ruff Lint Check Passed" >> "$GITHUB_STEP_SUMMARY"
          fi

  # -----------------------------------------
  # Verify PR Task List
  # -----------------------------------------
  checklist-validation:
    name: Checklist Validation
    runs-on: ubuntu-latest

    # Skip validation on draft PRs
    if: github.event.pull_request.draft == false

    steps:
      - name: Validate completed tasks
        # Uses the Task Completed Checker action to ensure all tasks in the PR body are checked
        # See usage instructions on the action page [oai_citation:0‡github.com](https://github.com/marketplace/actions/task-completed-checker#:~:text=Task%20Completed%20Checker%20Action)
        uses: kentaro-m/task-completed-checker-action@v0.1.2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
