name: PR Checklist Status

on:
  pull_request:
    branches: [main]

permissions:
  pull-requests: write
  contents: read

# Ensure only one run per PR at a time; cancel older runs on the same branch
concurrency:
  group: pr-check-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------
  # Lint & Format Check
  # -----------------------------------------
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Cache pip packages to speed up subsequent runs
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Install latest stable versions of formatting and linting tools
      - name: Install Black and Ruff
        run: |
          python -m pip install --upgrade pip
          # Pin to current releases (Nov 2025)
          pip install black==25.11.0 ruff==0.14.6

      # Check formatting using Black (fail if changes would be needed)
      - name: Run Black (format check)
        run: |
          black --check --diff . --exclude 'app.py'

      # Lint code using Ruff (fail if fixes would be applied)
      - name: Run Ruff (lint check)
        run: |
          # Ignore long-line rule (handled by Black)
          # Fail if Ruff would apply any fixes (--exit-non-zero-on-fix)
          ruff check . --ignore E501 --exit-non-zero-on-fix

  # -----------------------------------------
  # Verify PR Task List
  # -----------------------------------------
  checklist-validation:
    name: Checklist Validation
    runs-on: ubuntu-latest

    # Skip validation on draft PRs
    if: github.event.pull_request.draft == false

    steps:
      - name: Debug Token Permissions
        run: |
          echo 'Inspecting token permissions'
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/${{ github.repository }}/actions/permissions

      - name: Validate completed tasks
        # Uses the Task Completed Checker action to ensure all tasks in the PR body are checked
        # See usage instructions on the action page [oai_citation:0‡github.com](https://github.com/marketplace/actions/task-completed-checker#:~:text=Task%20Completed%20Checker%20Action)
        uses: kentaro-m/task-completed-checker-action@v0.1.2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # Alternative lightweight shell script verification (fallback)
      - name: Verify Checklist Items (Shell Script Alternative)
        if: failure()  # Only run if the action above fails
        run: |
          echo "Fetching PR body and checking for uncompleted tasks..."
          PR_BODY=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }})
          
          # Extract body text
          BODY_TEXT=$(echo "$PR_BODY" | jq -r '.body // ""')
          
          # Count uncompleted tasks (- [ ] pattern)
          UNCOMPLETED=$(echo "$BODY_TEXT" | grep -c '- \[ \]' || true)
          
          # Count completed tasks (- [x] or - [X] pattern)
          COMPLETED=$(echo "$BODY_TEXT" | grep -ciE '- \[[xX]\]' || true)
          
          echo "Checklist Summary:"
          echo "  Completed tasks: $COMPLETED"
          echo "  Uncompleted tasks: $UNCOMPLETED"
          
          if [ "$UNCOMPLETED" -gt 0 ]; then
            echo "❌ Error: PR has $UNCOMPLETED uncompleted checklist items"
            exit 1
          else
            echo "✅ All checklist items are completed!"
          fi