name: Python Style Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

# Avoid duplicate jobs on the same branch/tag; cancel older runs
concurrency:
  group: style-${{ github.ref }}
  cancel-in-progress: true

jobs:
  style-check:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v6

      # Set up Python and enable pip caching
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          cache: "pip"

      # Install style tools at current releases
      - name: Install style tools
        run: |
          python -m pip install --upgrade pip
          # Pin to current stable versions (Nov 2025)
          pip install \
            black==25.11.0 \
            flake8==7.3.0 \
            pre-commit==4.5.0 \
            ruff==0.14.6

      # Check code formatting with Black
      - name: Check code formatting with Black
        run: |
          black --check --diff --line-length=88 \
            --extend-exclude="app\.py|index\.html" .

      # Lint code with Flake8
      - name: Check code style with Flake8
        run: |
          flake8 . \
            --max-line-length=88 \
            --statistics \
            --show-source \
            --count

      # Optional: Lint with Ruff for faster, modern checks
      - name: Additional lint with Ruff
        run: |
          # Ignore long-line errors (handled by Black)
          # Fail if Ruff would apply any fixes
          ruff check . --ignore E501 --exit-non-zero-on-fix

      # Verify and run pre-commit hooks if configuration is present
      - name: Verify pre-commit config
        run: |
          if [ -f .pre-commit-config.yaml ]; then
            echo "✓ Pre-commit config found"
            pre-commit run --all-files --color always --show-diff-on-failure
          else
            echo "⚠ .pre-commit-config.yaml not found"
          fi

      # Summarize results in the GitHub job summary
      - name: Summary
        if: always()
        run: |
          echo "## Style Check Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Black formatting: completed" >> "$GITHUB_STEP_SUMMARY"
          echo "- Flake8 linting: completed" >> "$GITHUB_STEP_SUMMARY"
          echo "- Ruff linting: completed" >> "$GITHUB_STEP_SUMMARY"
          echo "- Pre-commit hooks: verified" >> "$GITHUB_STEP_SUMMARY"